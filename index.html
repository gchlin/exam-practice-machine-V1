<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ·é¡Œæ©Ÿ V1 - Windows 98 Edition</title>
  <link rel="stylesheet" href="css/win98.css">
</head>
<body>
  <div class="window">
    <div class="title-bar">
      <div class="title-bar-text">åˆ·é¡Œæ©Ÿ V1 - è¼‰å…¥é¡Œåº«</div>
      <div class="title-bar-controls">
        <button aria-label="Minimize">_</button>
        <button aria-label="Maximize">â–¡</button>
        <button aria-label="Close">âœ•</button>
      </div>
    </div>

    <div class="window-body">
      <div id="loadingScreen">
        <fieldset>
          <legend>æ­¡è¿ä½¿ç”¨åˆ·é¡Œæ©Ÿ</legend>
          
          <div style="text-align: center; margin: 20px 0;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“š</div>
            <h2 style="margin: 0 0 8px 0;">Windows 98 å¾©å¤é¢¨æ ¼åˆ·é¡Œç³»çµ±</h2>
            <p style="color: var(--win98-darkgray);">è®“æˆ‘å€‘é–‹å§‹æ‚¨çš„å­¸ç¿’ä¹‹æ—…</p>
          </div>

          <hr>

          <div class="field-row">
            <label style="min-width: 120px;">
              <input type="radio" name="loadMode" id="modeOnline" value="online" checked>
              ç·šä¸Šé¡Œåº«
            </label>
            <span style="flex: 1; font-size: 10px; color: var(--win98-darkgray);">
              ä½¿ç”¨å·²ä¸Šå‚³åˆ°ä¼ºæœå™¨çš„é¡Œåº«æª”æ¡ˆ
            </span>
          </div>

          <div class="field-row">
            <label style="min-width: 120px;">
              <input type="radio" name="loadMode" id="modeLocal" value="local">
              æœ¬åœ°æª”æ¡ˆ
            </label>
            <input type="file" id="dataFile" accept=".csv" style="flex: 1;" disabled>
          </div>

          <div class="field-row">
            <label for="imagesFolder">é¡Œç›®åœ–ç‰‡è³‡æ–™å¤¾è·¯å¾‘:</label>
            <input type="text" id="imagesFolder" value="./images/" style="flex: 1;">
          </div>

          <hr>

          <div id="loadStatus" class="hidden" style="margin: 16px 0; padding: 12px; background: var(--win98-white);">
            <div style="font-weight: bold; margin-bottom: 8px;">è¼‰å…¥ç‹€æ…‹:</div>
            <div id="statusText">æº–å‚™ä¸­...</div>
            <div class="progress-bar" style="margin-top: 8px;">
              <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
          </div>

          <div class="button-group center">
            <button id="loadBtn">
              <span>â–¶</span> é–‹å§‹ä½¿ç”¨
            </button>
          </div>
        </fieldset>

        <fieldset>
          <legend>ç³»çµ±è³‡è¨Š</legend>
          <div style="font-size: 10px; color: var(--win98-darkgray);">
            <p><strong>ç‰ˆæœ¬:</strong> V1.0.0</p>
            <p><strong>é¢¨æ ¼:</strong> Windows 98 Retro</p>
            <p><strong>åŠŸèƒ½:</strong> é¡Œåº«ç®¡ç† / é›£åº¦é æ¸¬ / ç·´ç¿’è¿½è¹¤ / çµ±è¨ˆåˆ†æ</p>
            <p><strong>è³‡æ–™å„²å­˜:</strong> ä½¿ç”¨ç€è¦½å™¨ localStorage</p>
          </div>
        </fieldset>
      </div>

      <div id="continueScreen" class="hidden">
        <fieldset>
          <legend>ç™¼ç¾æœªå®Œæˆçš„ç·´ç¿’</legend>
          
          <div style="text-align: center; margin: 20px 0;">
            <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
            <h3 style="margin: 0 0 8px 0;">æ‚¨æœ‰æœªå®Œæˆçš„ç·´ç¿’æœƒè©±</h3>
            <p style="color: var(--win98-darkgray);">æ˜¯å¦è¦ç¹¼çºŒä¸Šæ¬¡çš„ç·´ç¿’?</p>
          </div>

          <hr>

          <div id="sessionInfo" style="background: var(--win98-white); padding: 12px; margin: 12px 0;">
            <!-- æœƒè©±è³‡è¨Šå°‡ç”± JS å¡«å…¥ -->
          </div>

          <div class="button-group center">
            <button id="continueBtn">
              <span>âœ“</span> ç¹¼çºŒç·´ç¿’
            </button>
            <button id="newSessionBtn">
              <span>âœ•</span> é–‹å§‹æ–°çš„ç·´ç¿’
            </button>
          </div>
        </fieldset>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-bar-field">æº–å‚™å°±ç·’</div>
      <div class="status-bar-field" id="statusTime"></div>
    </div>
  </div>

  <script type="module">
    import { dataManager } from './js/dataManager.js';
    import { stateManager } from './js/stateManager.js';
    import { showDialog, showConfirm } from './js/utils.js';

    const dataFileInput = document.getElementById('dataFile');
    const loadBtn = document.getElementById('loadBtn');
    const loadStatus = document.getElementById('loadStatus');
    const statusText = document.getElementById('statusText');
    const progressFill = document.getElementById('progressFill');
    const loadingScreen = document.getElementById('loadingScreen');
    const continueScreen = document.getElementById('continueScreen');
    const sessionInfo = document.getElementById('sessionInfo');
    const modeOnline = document.getElementById('modeOnline');
    const modeLocal = document.getElementById('modeLocal');

    // æ›´æ–°æ™‚é–“
    function updateTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('zh-TW', { hour12: false });
      document.getElementById('statusTime').textContent = timeStr;
    }
    updateTime();
    setInterval(updateTime, 1000);

    // æ¨¡å¼åˆ‡æ›
    function updateLoadMode() {
      const isLocal = modeLocal.checked;
      dataFileInput.disabled = !isLocal;
      loadBtn.disabled = isLocal && !dataFileInput.files.length;
      
      if (!isLocal) {
        loadBtn.disabled = false;
      }
    }

    modeOnline.addEventListener('change', updateLoadMode);
    modeLocal.addEventListener('change', updateLoadMode);

    // æª”æ¡ˆé¸æ“‡äº‹ä»¶
    dataFileInput.addEventListener('change', (e) => {
      if (modeLocal.checked) {
        loadBtn.disabled = !e.target.files.length;
      }
    });

    // åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹
    updateLoadMode();

    // æª¢æŸ¥æ˜¯å¦åœ¨æœ¬åœ°ç’°å¢ƒ
    function checkEnvironment() {
      const protocol = window.location.protocol;
      
      if (protocol === 'file:') {
        // æœ¬åœ°ç’°å¢ƒï¼Œå»ºè­°ä½¿ç”¨æœ¬åœ°æ¨¡å¼æˆ–æœ¬åœ°ä¼ºæœå™¨
        const warning = document.createElement('div');
        warning.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; padding: 12px; margin: 12px 0; border-radius: 4px;';
        warning.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 8px;">âš ï¸ åµæ¸¬åˆ°æœ¬åœ°ç’°å¢ƒ</div>
          <div style="font-size: 10px;">
            <p style="margin: 4px 0;">æ‚¨æ­£åœ¨ä½¿ç”¨ file:// å”è­°é–‹å•Ÿï¼Œç·šä¸Šæ¨¡å¼å¯èƒ½ç„¡æ³•æ­£å¸¸é‹ä½œã€‚</p>
            <p style="margin: 4px 0;"><strong>å»ºè­°æ–¹æ¡ˆï¼š</strong></p>
            <ul style="margin: 4px 0 4px 16px; padding: 0;">
              <li>ä½¿ç”¨ã€Œæœ¬åœ°æª”æ¡ˆã€æ¨¡å¼ä¸Šå‚³ data.csv</li>
              <li>æˆ–ä½¿ç”¨æœ¬åœ°ä¼ºæœå™¨ï¼š<code style="background: #f5f5f5; padding: 2px 4px;">python -m http.server 8000</code></li>
              <li>æˆ–éƒ¨ç½²åˆ° GitHub Pages</li>
            </ul>
          </div>
        `;
        
        document.querySelector('.window-body').insertBefore(warning, document.querySelector('fieldset'));
        
        // è‡ªå‹•åˆ‡æ›åˆ°æœ¬åœ°æ¨¡å¼
        modeLocal.checked = true;
        updateLoadMode();
      }
    }

    // åŸ·è¡Œç’°å¢ƒæª¢æŸ¥
    checkEnvironment();

    // è¼‰å…¥é¡Œåº«æŒ‰éˆ•
    loadBtn.addEventListener('click', async () => {
      const isLocal = modeLocal.checked;
      
      if (isLocal) {
        const file = dataFileInput.files[0];
        if (!file) return;
        
        await loadQuestionBank(file);
      } else {
        // è¼‰å…¥ç·šä¸Šé¡Œåº«
        await loadQuestionBank('./data.csv');
      }
    });

    // é€šç”¨è¼‰å…¥å‡½æ•¸
    async function loadQuestionBank(source) {
      try {
        loadStatus.classList.remove('hidden');
        loadBtn.disabled = true;

        // æ­¥é©Ÿ 1: è¼‰å…¥é¡Œåº«
        statusText.textContent = 'æ­£åœ¨è¼‰å…¥é¡Œåº«...';
        progressFill.style.width = '25%';
        await dataManager.loadQuestions(source);

        // æ­¥é©Ÿ 2: è¼‰å…¥ç·´ç¿’ç´€éŒ„
        statusText.textContent = 'æ­£åœ¨è¼‰å…¥ç·´ç¿’ç´€éŒ„...';
        progressFill.style.width = '50%';
        await dataManager.loadFromLocalStorage();

        // æ­¥é©Ÿ 3: æª¢æŸ¥æœªå®Œæˆæœƒè©±
        statusText.textContent = 'æª¢æŸ¥æœªå®Œæˆçš„æœƒè©±...';
        progressFill.style.width = '75%';
        
        const hasUnfinished = stateManager.hasUnfinishedSession();
        
        // æ­¥é©Ÿ 4: å®Œæˆ
        statusText.textContent = 'è¼‰å…¥å®Œæˆ!';
        progressFill.style.width = '100%';

        setTimeout(() => {
          if (hasUnfinished) {
            showContinueScreen();
          } else {
            goToList();
          }
        }, 500);

      } catch (error) {
        console.error('è¼‰å…¥å¤±æ•—:', error);
        
        let errorMessage = 'è¼‰å…¥é¡Œåº«å¤±æ•—ã€‚\n\n';
        
        if (window.location.protocol === 'file:') {
          errorMessage += 'æ‚¨æ­£åœ¨ä½¿ç”¨æœ¬åœ°æª”æ¡ˆç³»çµ± (file://)ã€‚\n\n';
          errorMessage += 'è§£æ±ºæ–¹æ¡ˆï¼š\n';
          errorMessage += '1. åˆ‡æ›åˆ°ã€Œæœ¬åœ°æª”æ¡ˆã€æ¨¡å¼ä¸¦ä¸Šå‚³ CSV\n';
          errorMessage += '2. æˆ–ä½¿ç”¨æœ¬åœ°ä¼ºæœå™¨ï¼š\n';
          errorMessage += '   python -m http.server 8000\n';
          errorMessage += '3. æˆ–éƒ¨ç½²åˆ° GitHub Pages';
        } else if (error.message && error.message.includes('404')) {
          errorMessage += 'æ‰¾ä¸åˆ° data.csv æª”æ¡ˆã€‚\n\n';
          errorMessage += 'è«‹ç¢ºèªï¼š\n';
          errorMessage += '1. data.csv å·²ä¸Šå‚³åˆ°ä¼ºæœå™¨\n';
          errorMessage += '2. æª”æ¡ˆè·¯å¾‘æ­£ç¢º\n';
          errorMessage += '3. æª”åå¤§å°å¯«ä¸€è‡´';
        } else {
          errorMessage += 'éŒ¯èª¤è©³æƒ…ï¼š' + error.message + '\n\n';
          errorMessage += 'è«‹æª¢æŸ¥ï¼š\n';
          errorMessage += '1. æª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢º (UTF-8 ç·¨ç¢¼)\n';
          errorMessage += '2. CSV æ ¼å¼æ˜¯å¦ç¬¦åˆè¦ç¯„';
        }
        
        await showDialog('éŒ¯èª¤', errorMessage);
        loadBtn.disabled = false;
        loadStatus.classList.add('hidden');
      }
    }

    // é¡¯ç¤ºç¹¼çºŒç•«é¢
    function showContinueScreen() {
      const session = stateManager.currentSession;
      const progress = stateManager.getProgress();
      
      sessionInfo.innerHTML = `
        <div><strong>æ¨¡å¼:</strong> ${getModeName(session.mode)}</div>
        <div><strong>é€²åº¦:</strong> ${progress.current} / ${progress.total} (${progress.percentage}%)</div>
        <div><strong>å„²å­˜æ™‚é–“:</strong> ${new Date(session.startTime).toLocaleString('zh-TW')}</div>
      `;
      
      loadingScreen.classList.add('hidden');
      continueScreen.classList.remove('hidden');
    }

    // ç¹¼çºŒæŒ‰éˆ•
    document.getElementById('continueBtn').addEventListener('click', () => {
      window.location.href = 'practice.html';
    });

    // æ–°æœƒè©±æŒ‰éˆ•
    document.getElementById('newSessionBtn').addEventListener('click', async () => {
      const confirm = await showConfirm('ç¢ºèª', 'é€™å°‡æ¸…é™¤æœªå®Œæˆçš„ç·´ç¿’é€²åº¦ï¼Œç¢ºå®šè¦é–‹å§‹æ–°çš„ç·´ç¿’å—?');
      if (confirm) {
        stateManager.clearSession();
        goToList();
      }
    });

    // å‰å¾€åˆ—è¡¨é 
    function goToList() {
      window.location.href = 'list.html';
    }

    // å–å¾—æ¨¡å¼åç¨±
    function getModeName(mode) {
      const names = {
        'normal': 'ä¸€èˆ¬æ¨¡å¼',
        'same-chapter': 'åŒç« ç¯€æ¨¡å¼',
        'same-school': 'åŒå­¸æ ¡æ¨¡å¼',
        'same-difficulty': 'åŒé›£åº¦æ¨¡å¼'
      };
      return names[mode] || mode;
    }
  </script>
</body>
</html>
