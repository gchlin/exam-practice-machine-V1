<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ·é¡Œæ©Ÿ V1 - Windows 98 Edition</title>
  <link rel="stylesheet" href="css/win98.css">
</head>
<body>
  <div class="window">
    <div class="title-bar">
      <div class="title-bar-text">åˆ·é¡Œæ©Ÿ V1 - è¼‰å…¥é¡Œåº«</div>
      <div class="title-bar-controls">
        <button aria-label="Minimize">_</button>
        <button aria-label="Maximize">â–¡</button>
        <button aria-label="Close">âœ•</button>
      </div>
    </div>

    <div class="window-body">
      <div id="loadingScreen">
        <fieldset>
          <legend>æ­¡è¿ä½¿ç”¨åˆ·é¡Œæ©Ÿ</legend>
          
          <div style="text-align: center; margin: 20px 0;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“š</div>
            <h2 style="margin: 0 0 8px 0;">Windows 98 å¾©å¤é¢¨æ ¼åˆ·é¡Œç³»çµ±</h2>
            <p style="color: var(--win98-darkgray);">è®“æˆ‘å€‘é–‹å§‹æ‚¨çš„å­¸ç¿’ä¹‹æ—…</p>
          </div>

          <hr>

          <div class="field-row">
            <label for="dataFile">é¸æ“‡é¡Œåº«æª”æ¡ˆ (data.csv):</label>
            <input type="file" id="dataFile" accept=".csv" style="flex: 1;">
          </div>

          <div class="field-row">
            <label for="imagesFolder">é¡Œç›®åœ–ç‰‡è³‡æ–™å¤¾è·¯å¾‘:</label>
            <input type="text" id="imagesFolder" value="./images/" style="flex: 1;">
          </div>

          <hr>

          <div id="loadStatus" class="hidden" style="margin: 16px 0; padding: 12px; background: var(--win98-white);">
            <div style="font-weight: bold; margin-bottom: 8px;">è¼‰å…¥ç‹€æ…‹:</div>
            <div id="statusText">æº–å‚™ä¸­...</div>
            <div class="progress-bar" style="margin-top: 8px;">
              <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
          </div>

          <div class="button-group center">
            <button id="loadBtn" disabled>
              <span>â–¶</span> è¼‰å…¥é¡Œåº«
            </button>
            <button id="demoBtn">
              <span>ğŸ®</span> ä½¿ç”¨ç¯„ä¾‹è³‡æ–™
            </button>
          </div>
        </fieldset>

        <fieldset>
          <legend>ç³»çµ±è³‡è¨Š</legend>
          <div style="font-size: 10px; color: var(--win98-darkgray);">
            <p><strong>ç‰ˆæœ¬:</strong> V1.0.0</p>
            <p><strong>é¢¨æ ¼:</strong> Windows 98 Retro</p>
            <p><strong>åŠŸèƒ½:</strong> é¡Œåº«ç®¡ç† / é›£åº¦é æ¸¬ / ç·´ç¿’è¿½è¹¤ / çµ±è¨ˆåˆ†æ</p>
            <p><strong>è³‡æ–™å„²å­˜:</strong> ä½¿ç”¨ç€è¦½å™¨ localStorage</p>
          </div>
        </fieldset>
      </div>

      <div id="continueScreen" class="hidden">
        <fieldset>
          <legend>ç™¼ç¾æœªå®Œæˆçš„ç·´ç¿’</legend>
          
          <div style="text-align: center; margin: 20px 0;">
            <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
            <h3 style="margin: 0 0 8px 0;">æ‚¨æœ‰æœªå®Œæˆçš„ç·´ç¿’æœƒè©±</h3>
            <p style="color: var(--win98-darkgray);">æ˜¯å¦è¦ç¹¼çºŒä¸Šæ¬¡çš„ç·´ç¿’?</p>
          </div>

          <hr>

          <div id="sessionInfo" style="background: var(--win98-white); padding: 12px; margin: 12px 0;">
            <!-- æœƒè©±è³‡è¨Šå°‡ç”± JS å¡«å…¥ -->
          </div>

          <div class="button-group center">
            <button id="continueBtn">
              <span>âœ“</span> ç¹¼çºŒç·´ç¿’
            </button>
            <button id="newSessionBtn">
              <span>âœ•</span> é–‹å§‹æ–°çš„ç·´ç¿’
            </button>
          </div>
        </fieldset>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-bar-field">æº–å‚™å°±ç·’</div>
      <div class="status-bar-field" id="statusTime"></div>
    </div>
  </div>

  <script type="module">
    import { dataManager } from './js/dataManager.js';
    import { stateManager } from './js/stateManager.js';
    import { showDialog, showConfirm } from './js/utils.js';

    const dataFileInput = document.getElementById('dataFile');
    const loadBtn = document.getElementById('loadBtn');
    const demoBtn = document.getElementById('demoBtn');
    const loadStatus = document.getElementById('loadStatus');
    const statusText = document.getElementById('statusText');
    const progressFill = document.getElementById('progressFill');
    const loadingScreen = document.getElementById('loadingScreen');
    const continueScreen = document.getElementById('continueScreen');
    const sessionInfo = document.getElementById('sessionInfo');

    // æ›´æ–°æ™‚é–“
    function updateTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('zh-TW', { hour12: false });
      document.getElementById('statusTime').textContent = timeStr;
    }
    updateTime();
    setInterval(updateTime, 1000);

    // æª”æ¡ˆé¸æ“‡äº‹ä»¶
    dataFileInput.addEventListener('change', (e) => {
      loadBtn.disabled = !e.target.files.length;
    });

    // è¼‰å…¥é¡Œåº«æŒ‰éˆ•
    loadBtn.addEventListener('click', async () => {
      const file = dataFileInput.files[0];
      if (!file) return;

      try {
        loadStatus.classList.remove('hidden');
        loadBtn.disabled = true;
        demoBtn.disabled = true;

        // æ­¥é©Ÿ 1: è¼‰å…¥é¡Œåº«
        statusText.textContent = 'æ­£åœ¨è¼‰å…¥é¡Œåº«...';
        progressFill.style.width = '25%';
        await dataManager.loadQuestions(file);

        // æ­¥é©Ÿ 2: è¼‰å…¥ç·´ç¿’ç´€éŒ„
        statusText.textContent = 'æ­£åœ¨è¼‰å…¥ç·´ç¿’ç´€éŒ„...';
        progressFill.style.width = '50%';
        await dataManager.loadFromLocalStorage();

        // æ­¥é©Ÿ 3: æª¢æŸ¥æœªå®Œæˆæœƒè©±
        statusText.textContent = 'æª¢æŸ¥æœªå®Œæˆçš„æœƒè©±...';
        progressFill.style.width = '75%';
        
        const hasUnfinished = stateManager.hasUnfinishedSession();
        
        // æ­¥é©Ÿ 4: å®Œæˆ
        statusText.textContent = 'è¼‰å…¥å®Œæˆ!';
        progressFill.style.width = '100%';

        setTimeout(() => {
          if (hasUnfinished) {
            showContinueScreen();
          } else {
            goToList();
          }
        }, 500);

      } catch (error) {
        console.error('è¼‰å…¥å¤±æ•—:', error);
        await showDialog('éŒ¯èª¤', 'è¼‰å…¥é¡Œåº«å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚');
        loadBtn.disabled = false;
        demoBtn.disabled = false;
        loadStatus.classList.add('hidden');
      }
    });

    // ä½¿ç”¨ç¯„ä¾‹è³‡æ–™
    demoBtn.addEventListener('click', async () => {
      try {
        loadStatus.classList.remove('hidden');
        loadBtn.disabled = true;
        demoBtn.disabled = true;

        statusText.textContent = 'æ­£åœ¨è¼‰å…¥ç¯„ä¾‹è³‡æ–™...';
        progressFill.style.width = '25%';
        
        // è¼‰å…¥ä¸Šå‚³çš„ data.csv
        await dataManager.loadQuestions('./data.csv');
        
        progressFill.style.width = '50%';
        await dataManager.loadFromLocalStorage();

        statusText.textContent = 'è¼‰å…¥å®Œæˆ!';
        progressFill.style.width = '100%';

        setTimeout(() => {
          const hasUnfinished = stateManager.hasUnfinishedSession();
          if (hasUnfinished) {
            showContinueScreen();
          } else {
            goToList();
          }
        }, 500);

      } catch (error) {
        console.error('è¼‰å…¥ç¯„ä¾‹è³‡æ–™å¤±æ•—:', error);
        await showDialog('éŒ¯èª¤', 'æ‰¾ä¸åˆ°ç¯„ä¾‹è³‡æ–™æª”æ¡ˆ (data.csv)ï¼Œè«‹å…ˆä¸Šå‚³é¡Œåº«æª”æ¡ˆã€‚');
        loadBtn.disabled = false;
        demoBtn.disabled = false;
        loadStatus.classList.add('hidden');
      }
    });

    // é¡¯ç¤ºç¹¼çºŒç•«é¢
    function showContinueScreen() {
      const session = stateManager.currentSession;
      const progress = stateManager.getProgress();
      
      sessionInfo.innerHTML = `
        <div><strong>æ¨¡å¼:</strong> ${getModeName(session.mode)}</div>
        <div><strong>é€²åº¦:</strong> ${progress.current} / ${progress.total} (${progress.percentage}%)</div>
        <div><strong>å„²å­˜æ™‚é–“:</strong> ${new Date(session.startTime).toLocaleString('zh-TW')}</div>
      `;
      
      loadingScreen.classList.add('hidden');
      continueScreen.classList.remove('hidden');
    }

    // ç¹¼çºŒæŒ‰éˆ•
    document.getElementById('continueBtn').addEventListener('click', () => {
      window.location.href = 'practice.html';
    });

    // æ–°æœƒè©±æŒ‰éˆ•
    document.getElementById('newSessionBtn').addEventListener('click', async () => {
      const confirm = await showConfirm('ç¢ºèª', 'é€™å°‡æ¸…é™¤æœªå®Œæˆçš„ç·´ç¿’é€²åº¦ï¼Œç¢ºå®šè¦é–‹å§‹æ–°çš„ç·´ç¿’å—?');
      if (confirm) {
        stateManager.clearSession();
        goToList();
      }
    });

    // å‰å¾€åˆ—è¡¨é 
    function goToList() {
      window.location.href = 'list.html';
    }

    // å–å¾—æ¨¡å¼åç¨±
    function getModeName(mode) {
      const names = {
        'normal': 'ä¸€èˆ¬æ¨¡å¼',
        'same-chapter': 'åŒç« ç¯€æ¨¡å¼',
        'same-school': 'åŒå­¸æ ¡æ¨¡å¼',
        'same-difficulty': 'åŒé›£åº¦æ¨¡å¼'
      };
      return names[mode] || mode;
    }
  </script>
</body>
</html>
